<!DOCTYPE html>
<html class="ui-page-login">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="../css/mui.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <style>
			.area {
				margin: 20px auto 0px auto;
			}
			.mui-input-group:first-child {
				margin-top: 20px;
			}
			.mui-input-group label {
				width: 32%;
			}
			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				width: 68%;
			}
			.mui-checkbox input[type=checkbox],
			.mui-radio input[type=radio] {
				top: 6px;
			}
			.mui-content-padded {
				margin-top: 25px;
			}
			.mui-btn {
				padding: 10px;
			}
			.mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea{
				margin-top: 1px;
			}
			a,img{border:0;}
			body{font:12px/180% Arial, Helvetica, sans-serif, "新宋体";}

			.demo{width:300px; margin:60px auto 10px auto}
			@media only screen and (min-width: 420px) {
				.demo{width:500px; margin:60px auto 10px auto}
			}
			.demo p{line-height:36px}
			.button {
				display: inline-block;
				cursor:pointer;
				outline: none;
				text-align: center;
				text-decoration: none;
				padding: .5em 2em .55em;
				-webkit-border-radius: .5em;
				-moz-border-radius: .5em;
				border-radius: .5em;
				color: #606060;
				border: solid 1px #b7b7b7;
				background: #ededed;
			}
			.button:hover {
				text-decoration: none;
				background: #fff;
			}
			.button:active {
				position: relative;
				top: 1px;
				color: #999;
			}
    </style>
</head>

<body>
    <header class="mui-bar mui-bar-nav">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">修改密码</h1>
    </header>
    <div class="mui-content">
        <div style="display: none;" id="khid"></div>
        
        
        
        
        
        
        <form class="mui-input-group" style="margin-top: 20px;" >
            <div class="mui-input-row">
                <label>手机号码</label>
                <input id='phoneac' type="text" class="mui-input-clear mui-input" placeholder="请输入手机号码">
            </div>
            <div class="mui-input-row">
                <label> 密 码 </label>
                <input id='passwordac' type="password" class="mui-input-clear mui-input" placeholder="请输入登陆密码">
            </div>

        </form>
        
        
        
        
        
        
        
        <form class="mui-input-group" style="display: none;margin-top: 20px;">
            <div class="mui-input-row">
                <label>手机号码</label>
                <input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入手机号码">
            </div>
            <div class="mui-input-row">
                <label>验 证 码</label>
                <input id='validate' style="width: 30%;float: left;" type="email" class="mui-input-clear mui-input" placeholder="验证码">
                <input type="button" style="width: 30%; float: left;display: inline-block;outline: none;text-align: center;text-decoration: none;border: solid 1px #b7b7b7;background: #ededed;-webkit-border-radius: .5em; padding-left: .4rem	;-moz-border-radius: .5em;	cursor:pointer;" class="button" value="获取验证码" id="phone_btn" name="phone" onClick="showtime(30)">
            </div>

        </form>
        <form class="mui-input-group" style="display: none;margin-top: 20px;">
            <div class="mui-input-row">
                <label>卡号</label>
                <input type="text" id="hkicard" class="mui-input-clear mui-input kh" disabled="disabled" placeholder="号码池正在解析您的黑卡">
            </div>
            <div class="mui-input-row">
                <label>设置密码</label>
                <input id='password' type="password" class="mui-input-clear mui-input" placeholder="请输入登陆密码">
            </div>
            <div class="mui-input-row resi">
                <label>收货地址</label>
                <input id='address' type="email" class="mui-input-clear mui-input" placeholder="请输入收货地址">
            </div>
            <div class="mui-input-row resi">
                <label>性别</label>
               <select id="ussex">
                    <option value="true">男</option>
                    <option value="false">女</option>
                </select>
            </div>
            <div class="mui-input-row resi">
                <label>姓名</label>
                <input type="text" id="realName" class="mui-input-clear mui-input" placeholder="请输入姓名">
            </div>
            <div class="mui-input-row resi">
                <label>身份证号</label>
                <input type="text" id="ICard" class="mui-input-clear mui-input" placeholder="请输入身份证号">
            </div>
            <div class="mui-input-row resi">
                <label>是否有房</label>
                <select id="ISFz">
                    <option value="有房">是</option>
                    <option value="没房">否</option>
                </select>
            </div>
            <div class="mui-input-row resi">
                <label>是否有车</label>
                <select id="IScar">
                    <option value="有车">是</option>
                    <option value="没车">否</option>
                </select>
            </div>
        </form>
        <div class="mui-content-padded">
            <div style="float: left;margin: 10px;color:#D58512;cursor: pointer;" id="login">登陆</div>
            <div style="float: left;margin: 10px;color:#D58512;cursor: pointer;" id="regist">注册/忘记密码</div>
        </div>
        <div class="mui-content-padded">
            <button id='sendLogin' class="mui-btn mui-btn-block mui-btn-primary">登陆</button>
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/mui.min.js"></script>
    <script src="../js/MD5S.js"></script>
    <script src="../js/TravelTailorSafeInterface.js"></script>
    <script>
    	window.onload=function(){
    		bodyResize();
    		
    	}
        var step = 0;
    	
        var checkUrl = httppp+"/api/GetIcByRandom";
        var update = false;
        var dgroup = document.getElementsByClassName("mui-input-group");
        
        var sendLoginton = document.getElementById('sendLogin');
        document.getElementById("login").addEventListener("click", function () {
           mui.openWindow({
					url:"login.html",
					id:"login",
					show:{
						autoShow:true,//页面loaded事件发生后自动显示，默认为true
					},
					waiting:{
					
					}
				})
        });
        document.getElementById("regist").addEventListener("click", function () {
            dgroup[0].style.display = "none";
            dgroup[1].style.display = "block";
            sendLoginton.innerText = "下一步";
            step = 1;
            dgroup[2].style.display = "none";
        });
        document.getElementById("regist").click();
        function getKH() {
        	phone=$('#account').val();
        	 var ar = new Array();
                    ar.InterfaceAddress = "api/GetIcByRandom";
                    ar.userphone =phone;
                    ar.Handshake_Time = CurentTime('-', true);
                    aes(ar, "endgetKH");
		   
        }
		function endgetKH(rs){
			    var verData = eval('(' + rs + ')');
                            if (verData.suc) {
                                var kh = document.getElementsByClassName("kh");
                                document.getElementById("khid").value = verData.ReturnData.Id;
                                kh[0].value = verData.ReturnData.Icnum;
                            }
                            else{
                            	if(verData.ReturnDataTwo!=undefined&&verData.ReturnDataTwo!=null){
                            		document.getElementById("hkicard").value=verData.ReturnDataTwo.ICCard;
                                	document.getElementById("khid").value = verData.ReturnData.Id;
           							sendLoginton.innerText = "修改并返回";
                            		document.getElementById("khid").value = verData.ReturnData.Id;
                            		document.getElementById("password").value="";
                            		document.getElementById("password").placeholder="重置您的密码";
                            		document.getElementById("address").disabled=true;
                            		document.getElementById("address").value=verData.ReturnDataTwo.address;
                            		document.getElementById("realName").value=verData.ReturnDataTwo.UserName;
                            		document.getElementById("ICard").value=verData.ReturnDataTwo.ICard;
                            	}else{
                            		alert(verData.msg);
                            	}
                            }
		}
		   mui.plusReady(function () {
				if(plus.webview.getWebviewById("personage")!=undefined&&plus.webview.getWebviewById("personage")!=null)
							plus.webview.getWebviewById("personage").close();
				if(plus.webview.getWebviewById("integral")!=undefined&&plus.webview.getWebviewById("integral")!=null)
							plus.webview.getWebviewById("integral").close();
			});



        function endRegision(rs) {
            var verData = eval('(' + rs + ')');
            if (verData == undefined) {
                alert(rs);
                plus.runtime.restart();
            }
            else if (verData.suc) {
                localStorage.setItem("loginstate", "true");
                localStorage.setItem("loginPhone", verData.ReturnData.UserPhone);
                localStorage.setItem("loginPassword", $('#password').val());
                localStorage.setItem("loginaddress", verData.ReturnData.address);
                localStorage.setItem("UserName", verData.ReturnData.UserName);
                localStorage.setItem("UserId", verData.ReturnData.Id);
               mui.openWindow({
					url:"login.html",
					id:"login",
					show:{
						autoShow:true,//页面loaded事件发生后自动显示，默认为true
					},
					waiting:{
					
					}
				});
            } else {
                alert(verData.msg);
            }
        }
        function endLogin(rs) {
            var verData = eval('(' + rs + ')');
            if (verData == undefined) {
                alert(rs);
                plus.runtime.restart();
            }
            else if (verData.suc) {
                localStorage.setItem("loginstate", "true");
                localStorage.setItem("loginPhone", verData.ReturnData.UserPhone);
                localStorage.setItem("loginPassword", $('#passwordac').val());
                localStorage.setItem("UserName", verData.ReturnData.UserName);
                localStorage.setItem("UserId", verData.ReturnData.Id);
                mui.back();
            } else {
                alert(verData.msg);
            }
        }
        sendLogin.addEventListener('click', function () {
            if (step == 0) {
                var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
                if (myreg.test($('#phoneac').val())) {
                    sendLoginton.innerText = "登陆";
                    var ar = new Array();
                    ar.InterfaceAddress = "api/appLogin";
                    ar.phone = $('#phoneac').val();
                    ar.password = $('#passwordac').val();
                    ar.Handshake_Time = CurentTime('-', true);
                    aes(ar, "endLogin");
                } else {
                    alert("手机号验证错误");
                }
            }
           else if (step == 1) {
                step = 2;
                sendLoginton.innerText = "注册";
                dgroup[1].style.display = "none";
                dgroup[2].style.display = "block";
                getKH();
            } else if (step == 2) {
                if (document.getElementById("validate").value === localStorage.getItem("phonevaliede")) {
                    if (IdentityCodeValid($('#ICard').val())) {
                        var ar = new Array();
                        ar.InterfaceAddress = "api/AddUserInfo";
                        ar.cardID = document.getElementById("khid").value;
                        ar.phone = phone;
                        ar.password = $('#password').val();
                        ar.address = $('#address').val();
                        ar.realName = $('#realName').val();
                        ar.ICard = $('#ICard').val();
                        ar.sex=$('#ussex').val();
                        var re = $('#ISFz').val() + "," + $('#IScar').val();
                        ar.remark = re;
                        // ar.appid=plus.device.uuid;
                        ar.Handshake_Time = CurentTime('-', true);
                        aes(ar, "endRegision");
                    }
                } else {
                    alert("验证码无效，请重新获取");
                }

            }
            else {

            }
        }, false);

        var phone = "";
        function sendMessage() {
            phone = $("#account").val();
            var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
            if (myreg.test(phone)) {
                var ar = new Array();
                ar.InterfaceAddress = "api/Message";
                ar.messageData = 0;
                ar.phoneNum = phone;
                ar.Handshake_Time = CurentTime('-', true);
                aes(ar, "endMessage");
            } else {
                alert('请输入有效的手机号码！');
                return false;
            }
        }
        function endMessage(rs) {
            localStorage.setItem("phonevaliede", rs);

        }
        function showtime(t) {
            phone = $("#account").val();
            var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
            if (myreg.test(phone)) {

                document.getElementById("phone_btn").disabled = true;
                for (i = 1; i <= t; i++) {
                    if (i == 1) {
                        sendMessage();
                    }
                    window.setTimeout("update_p(" + i + "," + t + ")", i * 1000);
                }
            } else {
                alert('请输入有效的手机号码！');
                return false;
            }
        }

        function update_p(num, t) {
            if (num == t) {
                document.getElementById("phone_btn").value = " 重新发送 ";
                document.getElementById("phone_btn").disabled = false;
            }
            else {
                printnr = t - num;
                document.getElementById("phone_btn").value = "(" + printnr + ")重新发送";
            }
        }
    </script>
</body>

</html>